<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/ml5@0.2.3/dist/ml5.min.js" type="text/javascript"></script>

    <style>
      .image-select-btn{
      background-color:red;
      color:white;
      cursor:pointer;
      width:200px;
      padding:20px;
      }

      .classify-img{
      opacity:0;
      box-shadow:2px 2px 2px rgba(0, 0, 0, 0.2);
      object-fit:cover;
      margin:5px;
      }

    </style>
  </head>
  <body>
    <h1>画像の識別します!</h1>
    <div id="status-log"></div>
    <div>
      <div id="img-zone">
	<img class="classify-img"  src="" id="target-img"></img>
      </div>
      <div style="margin:100px;">
	<label id="select-img-label" class="image-select-btn">画像を選択
	  <input type="file" accept="image/*" name="imgfile" style="display:none" linktag="img-zone" class="select-img" id="select-img-input">
	</label>
      </div>
      <div id="result-table"></div>
    </div>
    
    <script>
var statusdiv = document.getElementById("status-log");
statusdiv.innerHTML = "モデルをロード中.";
var imglabel = document.getElementById("select-img-label");

imglabel.style.opacity = 0;

function modelLoaded(){
    statusdiv.innerHTML = "モデルのロード完了.<br>続いてパラメータをロード";

    classifier.load("model.json", function(){
	    statusdiv.innerHTML = "パラメータもロード完了.";
	    imglabel.style.opacity = 1;
	});
}

function modelReady(e){
};

const featureExtractor = ml5.featureExtractor('MobileNet', modelLoaded);
const classifier = featureExtractor.classification(modelReady);

$(document).ready(function(){
	$(".select-img").on('change', function(e){
		var tgt = e.target || window.event.srcElement,
		    files = tgt.files;
		var inputtag = $(this).attr("linktag");
		
		if (FileReader && files && files.length) {
		    var fr = new FileReader();
		    fr.onload = function () {
			var timg = $("#target-img");
			timg.attr("src", fr.result);
			timg.css("opacity", 1);
			
			classifier.classify(timg[0], function(err, results){
				if(err){
				    alert(err);
				}else{
                                    var srcimg = $("#target-img").attr("src");
				    var cellimg = "<img style='object-fit:cover' width='100px' height='100px' src=" + srcimg + "></img>";
				    var cellresult = "<div style='color:red'>"+results[0].label+" : "+(results[0].confidence*100)+"%</div>";
				    $("#result-table").append("<div style='display:table-row;'><div style='display:table-cell;width:150px;'>"+cellimg+"</div><div style='display:table-cell;vertical-align:middle;'>"+cellresult+"</div></div>");
				}
			    });
		    }
		    fr.readAsDataURL(files[0]);
		}
	    });

    });
      

    </script>
  </body>
</html>
